<!DOCTYPE html>
<html>

<head>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/png">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans+Condensed:wght@300&display=swap">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="css/loader-default.css">
    <link rel="stylesheet" href="css/links.css">
    <link rel="stylesheet" href="css/modal.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <title>Связи ИСЭ-СИО</title>
</head>

<body style="padding: 0 24px;">

    <div id="app">
        <h1>{{page_id}}</h1>
        <div id="loader" v-bind:class="(waiting)?'is-active':''" class="loader loader-default"></div>
        <div class="error-box" v-show="error" style="display: none;">{{error}}</div>
        <section>
            <tree :nodes="nodes"></tree>
        </section>

        <div id="openModal" class="modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Название</h3>
                        <a href="#close" title="Close" class="close">×</a>
                    </div>
                    <div class="modal-body">
                        <table>
                            <tr v-for="(row) in modal" class="prop">
                                <td>{{row.LABEL}}</td>
                                <td>{{row.DT}}</td>
                                <td>{{row.TRAN_ID}}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const EVENT_SHOW_ISE_INFO = 'show-ise-info';
        const EVENT_EXPAND_NODE = 'expand-node';
        const EVENT_FIND_TRASACTS = 'find-transacts';

        Vue.component('tab', {
            template: `
            <table class="props">
                <tr v-for="(val, name, index) in obj.visible" class="prop">
                    <td>{{name}}</td>
                    <td v-if="index === 0">
                        <span>{{val}}</span>&nbsp&nbsp
                        <span class="as-link" v-on:click="findTransacts($event, val)">find log</span>
                    </td>
                    <td v-else>{{val}}</td>
                </tr>
            </table>
            `,
            props: ['obj'],
            methods: {
                findTransacts: async function (e, val) {
                    this.$root.$emit(EVENT_FIND_TRASACTS, e.target, val);
                },
            }
        });

        Vue.component('tree', {

            template: `
<div>
    <details v-for="(item, index) in nodes" :key="item.id" :open="item.selected ? true : false" 
        v-bind:class="{'bad': item.audit.length > 0}" >
        <summary v-bind:class="{'selected': item.equals}" v-on:click="loadChildren($event, item)"><i v-bind:class="'fa fa-' + item.icon"></i><span class="as-link">{{item.title}}</span></summary>
        <div>
            <div class="props">
                <tab :obj="item"></tab>
                <span class="as-link" v-show="!item.ise_loaded" v-on:click="showIseInfo(item)">Дополнительно >></span>
                <div v-show="item.ise_loaded" class="ise">
                    <hr color="#ccc" size="1"/>
                    <tab v-for="(item, index) in item.ise_nodes" :key="item.id" :obj="item" v-bind:class="item.visible.tag"></tab>
                </div>
            </div>

            <details v-show="item.audit.length" class="problems">
                <summary>Проблемы</summary>
                <div class="problems">
                    <table>
                        <tr v-for="(a, i) in item.audit">
                            <td>{{a.IDX}}</td>
                            <td>{{a.VAL}}</td>
                            <td>{{a.VAL2}}</td>
                        </tr>
                    </table>
                </div>
            </details>
        </div>
        <div class="shifted">
            <tree :nodes="item.nodes"></tree>
        </div>
    </details>
</div>
`,
            props: ['nodes'],
            methods: {
                setDetailsClasses: function (isSelected, hasError) {
                    return {
                        selected: isSelected,
                        bad: hasError
                    }
                },
                showIseInfo: async function (item) {
                    this.$root.$emit(EVENT_SHOW_ISE_INFO, item);
                },
                loadChildren: async function (e, item) {
                    this.$root.$emit(EVENT_EXPAND_NODE, e.target, item);
                },
            }
        });


        var app = new Vue({
            el: '#app',
            data: {
                waiting: false,
                modal: [],
                error: null,
                page_id: '',
                nodes: [],
            },
            created() {
                console.log('Here!');

                try {
                    const pair = location.href.split('?')[1].split('&')[0].split('=');
                    const key_name = pair[0].toLowerCase();
                    const key = pair[1];
                    // document.title = this.id;
                    if (key_name === 'sio') {
                        this.loadInfo(key);
                    } else {
                        throw new Error('Ошибка в URL: не указан параметр SIO или ISE')
                    }
                } catch (ex) {
                    this.error = ex.message;
                }
            },
            mounted: function () {
                this.$root.$on(EVENT_SHOW_ISE_INFO, this.onShowIseInfo);
                this.$root.$on(EVENT_EXPAND_NODE, this.loadChildren);
                this.$root.$on(EVENT_FIND_TRASACTS, this.findTransacts);
            },
            methods: {
                showModal: function (doShow) {
                    if (doShow) {
                        document.body.style.overflow = 'hidden';
                        document.querySelector('#openModal').style.marginLeft = scrollbar;
                    } else {
                        document.body.style.overflow = 'visible';
                        document.querySelector('#openModal').style.marginLeft = '0px';
                    }
                },
                loadInfo: async function (sioKey) {
                    this.waiting = true;
                    try {
                        const res = await fetch(`/api/v2/links/info/${sioKey}`);
                        this.nodes = await res.json();
                        this.page_id = decodeURI(sioKey);
                        // console.log(this.items);
                    } catch (ex) {
                        this.error = ex.message;
                    }
                    this.waiting = false;
                },
                loadChildren: async function (element, item) {
                    console.log(item);
                    if (item.source === 'ISE' || item.loaded) {
                        return;
                    }
                    let answer = [];
                    this.waiting = true;
                    const node = this.findSioNodeById(this.nodes, item.id);
                    try {
                        let res = await fetch(`/api/v1/links/node-children/${item.id}`);
                        answer = await res.json();
                        if (res.status === 500) {
                            element.parentElement.classList.add('bad');
                            element.title = answer.message;
                            throw new Error(answer.message);
                        }
                        node.nodes = answer;
                        node.loaded = true;

                        res = await fetch(`/api/v1/links/check-children/${item.id}`);
                        answer = await res.json();
                        if (res.status === 500) {
                            throw new Error(answer.message);
                        }
                        for (const [key, val] of Object.entries(answer.audit)) {
                            const child = this.findSioNodeById(node.nodes, key);
                            if (child) {
                                if (child.audit === undefined) {
                                    child.audit = [];
                                }
                                child.audit.push(val);
                            }
                        }
                    } catch (ex) {
                        this.error = ex.message;
                        node.error = true;
                        console.error(ex.message + ' ' + ex.stack);
                    }
                    this.waiting = false;
                    return answer;
                },
                onShowIseInfo: async function (item) {
                    let answer = [];
                    this.waiting = true;
                    try {
                        const node = this.findSioNodeById(this.nodes, item.id);

                        let res = await fetch(`/api/v1/links/sio2ise/${item.id}`);
                        answer = await res.json();
                        node.ise_nodes = answer.ise_nodes;
                        node.ise_loaded = true;
                    } catch (ex) {
                        this.error = ex.message;
                    }
                    this.waiting = false;
                    return answer;
                },
                findTransacts: async function (element, value) {
                    let rows = [];
                    this.waiting = true;
                    try {
                        const key = value;
                        console.log('finding...' + key);

                        let res = await fetch(`/api/v1/links/log/${key}`);
                        rows = await res.json();

                        if(rows.length > 0){
                            const r = rows[0];
                            window.open(`/mdmtransact.html?id=${r.TRAN_ID}`, r.TRAN_ID, "menubar=off,toolbar=off,location=off");
                        }
                        else{
                            this.error = 'В логе не найдено';
                        }
                        console.log(rows);
                        // this.showModal(true);

                    } catch (ex) {
                        this.error = ex.message;
                    }
                    this.waiting = false;
                    return rows;
                },
                findSioNodeById: function (nodes, id) {
                    for (const node of nodes) {
                        if (node.id === id) {
                            return node;
                        }
                        const child = this.findSioNodeById(node.nodes, id);
                        if (child !== null) {
                            return child;
                        }
                    }
                    return null;
                }
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            var scrollbar = document.body.clientWidth - window.innerWidth + 'px';
            document.querySelector('[href="#close"]').addEventListener('click', function () {
                document.body.style.overflow = 'visible';
                document.querySelector('#openModal').style.marginLeft = '0px';
            });
        });
    </script>

</body>

</html>